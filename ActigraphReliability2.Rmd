---
title: "Actigraph Reliability Comparison with GGIR"
author: "Kathryn Freeman"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: yes
    toc_float: true
    number_sections: no
    theme: cerulean
    code_folding: hide
---

## Coefficient of Agreement: Intraclass correlation Coefficient

* Interpreting ICC according to Koo and Li (2016)
  + Values less than 0.5 = poor reliability 
  + Values between 0.5 and 0.75 = moderate reliability
  + Values between 0.75 and 0.9 = good reliability
  + Values greater than 0.9 = excellent reliability



## Set-up {.tabset}

### Load packages
```{r}
library(here)
library(readr)
library(lubridate)
library(tidyverse) # ggplot, dplyr, tidyr, readr, purr, tibble
library(ICC) # ICC and CI
```

### Load data
```{r}
#Import data
df <- read_csv(here("data", "compiledsleepdata.csv"))

#View data
df

```

### ICC Function
```{r}
ga2_md <- function(p, m, n, o){
  
  icc_calc <- irrICC::icc1a.fn(p) 
  icc_calc_ci <- irrICC::ci.ICC1a(p) 
  icc_calc_pval <- irrICC::pvals.ICC1a(p)

  "ICC" <- (icc_calc$icc1a) 
  
classify_icc <- 
    c("ICC" = (icc_calc$icc1a) %>% round(digits = 4),
    "2.5% CI" = (icc_calc_ci$lcb) %>% round(digits = 4),
    "97.5% CI" = (icc_calc_ci$ucb) %>% round(digits = 4),
    "p-value" = (icc_calc_pval$pval) %>% round(digits = 4),
    "Nights" = (icc_calc$n) %>% round(digits = 1),
    "Raters" = (icc_calc$r) %>% round(digits = 1),
    "Class" = case_when(
    icc_calc$icc1a > 0.90 ~ "Excellent",
    icc_calc$icc1a <= 0.9 & icc_calc$icc1a > 0.75 ~ "Good",
    icc_calc$icc1a <= 0.75 & icc_calc$icc1a > 0.5 ~ "Moderate",
    icc_calc$icc1a < 0.5  ~ "Poor"))
    
print(classify_icc) 

plot <- ggplot((p), aes(x=g1, y=g2)) + geom_point() +
geom_smooth(method=lm, se=FALSE) +
labs(title = m, subtitle = "Two GENEActivs using Markdown") +
labs(x = n) +
labs(y = o)


print(plot)
}
```

### Time Functions
```{r}
adjtime <- function(x) {df %>%
  mutate(rawtime = (((hour(hms(x)*60) + (minute(hms(x)) + (600)))))) %>%
  mutate(adjtime = (ifelse(rawtime>1439, rawtime-1440, rawtime)))
}

sleepduration <- function (y) {df %>%
  mutate(dur = (adjtime(df$etime)$adjtime - (adjtime(df$stime)$adjtime)))
}

sleepmid <- function (w) {df %>%
  mutate(mid = ((adjtime(df$etime)$adjtime + (adjtime(df$stime)$adjtime))/2))
}
```

## GENEActiv Markdown data {.tabset}

### Time in Bed (tinb)
#### Time in Bed (tinb)
##### tinb = total duration of time spent in bed
```{r}
tinb_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (tinb)))

ga2_md(tinb_ga2_md, "Time Spent in Bed", "GENEActiv 1 (mins)", "GENEActiv 2 (mins)")
```
### Percent Sleep (pslp)
#### Percent Sleep (pslp)
##### pslp = (Sleep Minutes / Duration in Bed) x 100
```{r}
pslp_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (pslp)))

ga2_md(pslp_ga2_md, "Percent Sleep", "GENEActiv 1 (percent)", "GENEActiv 2 (percent)")
```
### Sleep Minutes (smin)
#### Sleep Minutes (smin)
##### smin = minutes asleep in bed
```{r}
smin_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (smin)))

ga2_md(smin_ga2_md, "Sleep Minutes", "GENEActiv 1 (mins)", "GENEActiv 2 (mins)")
```
### Wake Minutes (wmin)
#### Wake Minutes (wmin)
##### wmin = minutes awake in bed
```{r}
wmin_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (wmin)))

ga2_md(wmin_ga2_md, "Wake Minutes", "GENEActiv 1 (mins)", "GENEActiv 2 (mins)")
```
### Wake-up Time (etime)
#### Wake-up Time (etime)
##### etime = time awakened from sleep in morning
###### Adjusted to 2pm = 0:00 in minutes since 2pm
```{r}
etime_ga2_md <-  (pivot_wider(adjtime(df$etime) %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (adjtime)))

ga2_md(etime_ga2_md, "Wake-up Time", "GENEActiv 1 (mins after 2pm)","GENEActiv 2 (mins after 2pm)")
```
### Sleep Time (stime)
#### Sleep Time (stime)
##### stime = time fell asleep at night
###### Adjusted to 2pm = 0:00 in mins since 2pm
```{r}

stime_ga2_md <- (pivot_wider(adjtime(df$stime) %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (adjtime)))

ga2_md(stime_ga2_md, "Sleep Time", "GENEActiv 1 (mins after 2pm)","GENEActiv 2 (mins after 2pm)")
```
### Total Sleep Duration (dur)
#### Total Sleep Duration (dur)
##### dur = time between fall asleep time and wake-up time
```{r}
dur_ga2_md <- (pivot_wider(sleepduration(1) %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = dur))

ga2_md(dur_ga2_md, "Sleep Duration", "GENEActiv 1 (mins)","GENEActiv 2 (mins")
```

### Sleep Midpoint (mid)
#### Sleep Midpoint (mid)
##### mid = middle of sleep period
```{r}
mid_ga2_md <- (pivot_wider(sleepmid(1) %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = mid))

ga2_md(mid_ga2_md, "Sleep Midpoint", "GENEActiv 1 (mins after 2pm)","GENEActiv 2 (mins after 2pm)")
```



## GENEActiv GGIR data {.tabset}

### Time in Bed (tinb)
#### Time in Bed (tinb)
##### tinb = total duration of time spent in bed


### Percent Sleep (pslp)
#### Percent Sleep (pslp)
##### pslp = (Sleep Minutes / Duration in Bed) x 100


### Sleep Minutes (smin)
#### Sleep Minutes (smin)
##### smin = minutes asleep in bed


### Wake Minutes (wmin)
#### Wake Minutes (wmin)
##### wmin = minutes awake in bed


### Wake-up Time (etime)
#### Wake-up Time (etime)
##### etime = time awakened from sleep in morning
###### Adjusted to 2pm = 0:00 in minutes since 2pm

### Sleep Time (stime)
#### Sleep Time (stime)
##### stime = time fell asleep at night
###### Adjusted to 2pm = 0:00 in mins since 2pm

### Total Sleep Duration (dur)
#### Total Sleep Duration (dur)
##### dur = time between fall asleep time and wake-up time

### Sleep Midpoint (mid)
#### Sleep Midpoint (mid)
##### mid = middle of sleep period

