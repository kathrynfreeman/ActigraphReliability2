---
title: "Actigraph Reliability Comparison with GGIR"
author: "Kathryn Freeman"
date: '`r Sys.Date()`'
output:
  html_notebook:
    toc: yes
    toc_float: true
    number_sections: no
    theme: cerulean
    code_folding: hide
---

## Coefficient of Agreement: Intraclass correlation Coefficient

* Interpreting ICC according to Koo and Li (2016)
  + Values less than 0.5 = poor reliability 
  + Values between 0.5 and 0.75 = moderate reliability
  + Values between 0.75 and 0.9 = good reliability
  + Values greater than 0.9 = excellent reliability



## Set-up {.tabset}

### Load packages
```{r}
library(here)
library(readr)
library(lubridate)
library(tidyverse) # ggplot, dplyr, tidyr, readr, purr, tibble
library(ICC) # ICC and CI
```

### Load data
```{r}
#Import data
df <- read_csv(here("data", "compiledsleepdata.csv"))

#View data
df

```

### Create Function
```{r}
ga2_md <- function(p){
  
  icc_calc <- irrICC::icc1a.fn(p) 
  icc_calc_ci <- irrICC::ci.ICC1a(p) 
  icc_calc_pval <- irrICC::pvals.ICC1a(p)

  "ICC" <- (icc_calc$icc1a) 
  
classify_icc <- 
    c("ICC" = (icc_calc$icc1a) %>% round(digits = 4),
    "2.5% CI" = (icc_calc_ci$lcb) %>% round(digits = 4),
    "97.5% CI" = (icc_calc_ci$ucb) %>% round(digits = 4),
    "p-value" = (icc_calc_pval$pval) %>% round(digits = 4),
    "Nights" = (icc_calc$n) %>% round(digits = 1),
    "Raters" = (icc_calc$r) %>% round(digits = 1),
    "Class" = case_when(
    icc_calc$icc1a > 0.90 ~ "Excellent",
    icc_calc$icc1a <= 0.9 & icc_calc$icc1a > 0.75 ~ "Good",
    icc_calc$icc1a <= 0.75 & icc_calc$icc1a > 0.5 ~ "Moderate",
    icc_calc$icc1a < 0.5  ~ "Poor"))
    
print(classify_icc) 

plot <- ggplot((p), aes(x=g1, y=g2)) + geom_point() +
geom_smooth(method=lm, se=FALSE) +
labs(title = "Time Spent in Bed", subtitle = "Two GENEActivs using Markdown") +
labs(x = "GENEActiv 1 (mins)") +
labs(y = "GENEActiv 2 (mins)")


print(plot)
}
```

### Adjust time to mins since 2pm
```{r}

```

## GENEActiv Markdown data {.tabset}

### Time in Bed (tinb)
```{r}
tinb_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (tinb)))

ga2_md(tinb_ga2_md)
```
### Percent Sleep (pslp)
```{r}
pslp_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (pslp)))

ga2_md(pslp_ga2_md)
```
### Sleep Minutes (smin)
```{r}
smin_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (smin)))

ga2_md(smin_ga2_md)
```
### Wake Minutes (wmin)
```{r}
wmin_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (wmin)))

ga2_md(wmin_ga2_md)
```
### Wake-up Time (etime)
```{r}
etime_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (etime)))

ga2_md(etime_ga2_md)
```
### Sleep Time (stime)
```{r}

stime_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (stime)))

ga2_md(stime_ga2_md)
```
### Total Sleep Duration (dur)
```{r}
dur_ga2_md <- (pivot_wider(df %>% filter(analysis == "markdown") %>% 
  filter(actigraph == "g1" | actigraph == "g2"), night, 
  names_from = actigraph, values_from = (etime-stime)))

ga2_md(dur_ga2_md)
```

### Sleep Midpoint (mid)





### Time in Bed (tinb)
### Percent Sleep (pslp)
### Sleep Minutes (smin)
### Wake Minutes (wmin)
### Wake-up Time (etime)
### Sleep Time (stime)
### Total Sleep Duration (dur)
### Sleep Midpoint (mid)

